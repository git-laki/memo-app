<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>本日のタスク</title>

  <link rel="apple-touch-icon" href="icon.png">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial;
      background: #fff;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      text-align: center;
    }

    textarea {
      width: 100%;
      height: 150px;
      font-size: 18px;
      padding: 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    #viewMode,
    #editMode {
      text-align: center;
    }

    button {
      font-size: 16px;
      padding: 8px 16px;
      margin-top: 16px;
      cursor: pointer;
    }

    .task {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      gap: 10px;
    }

    .left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .left span {
      font-size: 18px;
      text-align: left;
    }

    .done {
      text-decoration: line-through;
      color: #888;
    }

    .play {
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      flex-shrink: 0;
    }

    .hidden {
      display: none;
    }

    input[type="checkbox"] {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  appearance: none;
  border: 1px solid #bbb;
  position: relative;
  flex-shrink: 0;
}

input[type="checkbox"]:checked {
  background: #fca21e;
  border-color: #fca21e;
}

input[type="checkbox"]:checked::after {
  content: "";
  position: absolute;
  top: 3px;
  left: 6px;
  width: 4px;
  height: 8px;
  border: solid #fff;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

  </style>
</head>
<body>

<h1>本日のタスク</h1>

<div id="viewMode">
  <div id="taskList"></div>
  <button id="editBtn">編集</button>
</div>

<div id="editMode" class="hidden">
  <textarea id="taskInput"></textarea>
  <br/>
  <button id="saveBtn">保存</button>
</div>

<script>
  /* ------------------------------
    Storage Keys
  ------------------------------ */
  const STORAGE_KEYS = {
    TASKS: "tasks",
    RUNNING_INDEX: "runningTaskIndex",
    START_TIME: "startTime",
  };
  
  /* ------------------------------
    State
  ------------------------------ */
  let tasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.TASKS) || "[]");
  let runningTaskIndex = null;
  let startTime = null;
  
  /* ------------------------------
    Elements
  ------------------------------ */
  const taskList = document.getElementById("taskList");
  const editBtn = document.getElementById("editBtn");
  const saveBtn = document.getElementById("saveBtn");
  const taskInput = document.getElementById("taskInput");
  const viewMode = document.getElementById("viewMode");
  const editMode = document.getElementById("editMode");
  
  /* ------------------------------
    Utils
  ------------------------------ */
  function saveTasks() {
    localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
  }
  
  function saveTimerState() {
    if (runningTaskIndex === null || startTime === null) {
      localStorage.removeItem(STORAGE_KEYS.RUNNING_INDEX);
      localStorage.removeItem(STORAGE_KEYS.START_TIME);
      return;
    }
    localStorage.setItem(STORAGE_KEYS.RUNNING_INDEX, String(runningTaskIndex));
    localStorage.setItem(STORAGE_KEYS.START_TIME, String(startTime));
  }
  
  function loadTimerState() {
    const idx = localStorage.getItem(STORAGE_KEYS.RUNNING_INDEX);
    const st = localStorage.getItem(STORAGE_KEYS.START_TIME);
  
    if (idx === null || st === null) return;
  
    runningTaskIndex = Number(idx);
    startTime = Number(st);
  }
  
  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    return h > 0 ? `${h}h${m}m` : `${m}m`;
  }
  
  /* ------------------------------
    Render
  ------------------------------ */
  function render() {
    taskList.innerHTML = "";
  
    const order = tasks
      .map((task, index) => ({ task, index }))
      .sort((a, b) => {
        const aRunning = a.index === runningTaskIndex;
        const bRunning = b.index === runningTaskIndex;
        if (aRunning !== bRunning) return aRunning ? -1 : 1;
  
        const aDone = !!a.task.done;
        const bDone = !!b.task.done;
        if (aDone !== bDone) return aDone ? 1 : -1;
  
        return a.index - b.index;
      });
  
    order.forEach(({ task, index }) => {
      const row = document.createElement("div");
      row.className = "task";
  
      const left = document.createElement("div");
      left.className = "left";
  
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = !!task.done;
      checkbox.style.pointerEvents = "none";
  
      const label = document.createElement("span");
      label.textContent = task.text + (task.time ? `（${task.time}）` : "");
      if (task.done) label.classList.add("done");
  
      left.appendChild(checkbox);
      left.appendChild(label);
  
      const play = document.createElement("span");
      play.className = "play";
      play.textContent = runningTaskIndex === index ? "実行中" : "▶︎";
  
      row.onclick = () => {
        if (task.done) return;
  
        if (runningTaskIndex === index) {
          const elapsed = Date.now() - startTime;
          task.time = formatTime(elapsed);
          task.done = true;
  
          runningTaskIndex = null;
          startTime = null;
  
          saveTimerState();
          saveTasks();
          render();
          return;
        }
  
        runningTaskIndex = index;
        startTime = Date.now();
        saveTimerState();
        render();
      };
  
      // 長押し削除
      let pressTimer = null;
  
      row.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => {
          if (!confirm(`削除しますか？\n\n${task.text}`)) return;
  
          tasks.splice(index, 1);
          saveTasks();
          render();
        }, 600);
      });
  
      row.addEventListener("touchend", () => clearTimeout(pressTimer));
      row.addEventListener("touchmove", () => clearTimeout(pressTimer));
  
      row.appendChild(left);
      row.appendChild(play);
      taskList.appendChild(row);
    });
  }
  
  /* ------------------------------
    Edit Mode
  ------------------------------ */
  editBtn.onclick = () => {
    taskInput.value = tasks.map((t) => "・" + t.text).join("\n");
    viewMode.classList.add("hidden");
    editMode.classList.remove("hidden");
  };
  
  /* Enterで・を追加 */
  let isComposing = false;

taskInput.addEventListener("compositionstart", () => {
  isComposing = true;
});

taskInput.addEventListener("compositionend", () => {
  isComposing = false;
  fixBullets();
});

taskInput.addEventListener("input", () => {
  if (isComposing) return;
  fixBullets();
});

function fixBullets() {
  const lines = taskInput.value.split("\n");

  const fixed = lines.map((line, i) => {
    if (line === "") return line;
    return line.startsWith("・") ? line : "・" + line;
  });

  taskInput.value = fixed.join("\n");
}


  
  saveBtn.onclick = () => {
    const lines = taskInput.value
      .split("\n")
      .map((l) => l.replace(/^・/, "").trim())
      .filter(Boolean);
  
    const map = new Map(tasks.map((t) => [t.text, t]));
    const nextTasks = [];
  
    for (const text of lines) {
      if (map.has(text)) nextTasks.push(map.get(text));
      else nextTasks.push({ text, done: false, time: null });
    }
  
    tasks = nextTasks;
  
    saveTasks();
    render();
  
    editMode.classList.add("hidden");
    viewMode.classList.remove("hidden");
  };
  
  /* ------------------------------
    Boot
  ------------------------------ */
  loadTimerState();
  render();
  </script>
  
  

</body>
</html>